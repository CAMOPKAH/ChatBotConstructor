{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<style>
    .CodeMirror {
        border: 1px solid #ced4da;
        height: 400px;
    }

    .CodeMirror-fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        height: 100% !important;
        z-index: 9999;
    }

    .cm-error-line {
        background-color: #ffcccc !important;
    }
</style>

<h2>Workflow Editor</h2>
<div class="row">
    <div class="col-md-8">
        <div id="cy" style="width: 100%; height: 600px; border: 1px solid #ccc; position: relative;">
            <div style="position: absolute; top: 10px; right: 10px; z-index: 999;">
                <button class="btn btn-sm btn-light border" onclick="zoomIn()">+</button>
                <button class="btn btn-sm btn-light border" onclick="zoomOut()">-</button>
                <button class="btn btn-sm btn-light border" onclick="fitGraph()">Fit</button>
                <button class="btn btn-sm btn-success" onclick="addBlock()">Add Block</button>
                <button class="btn btn-sm btn-primary" onclick="applyLayout()">Auto Layout</button>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">Edit Block</div>
            <div class="card-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label class="form-label">Block ID</label>
                        <input type="text" id="blockId" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Block Name</label>
                        <input type="text" id="blockName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Script Code</label>
                        <div class="d-flex justify-content-end mb-1">
                            <button type="button" class="btn btn-sm btn-outline-secondary me-1"
                                onclick="formatCode()">Format Code</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                onclick="toggleFullscreen()">Fullscreen</button>
                        </div>
                        <textarea id="blockCode" class="form-control" rows="15"></textarea>
                    </div>
                    <div class="mb-3">
                        <button type="button" onclick="runCode()" class="btn btn-warning w-100">Run / Test Code</button>
                        <pre id="runOutput" class="mt-2 p-2 border bg-light"
                            style="display:none; max-height: 150px; overflow: auto;"></pre>
                    </div>
                    <div class="d-flex justify-content-between">
                        <button type="button" onclick="saveBlock()" class="btn btn-primary">Save Code</button>
                        <button type="button" onclick="deleteBlock()" class="btn btn-danger" id="deleteBtn"
                            style="display: none;">Delete Block</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape-dagre/2.5.0/cytoscape-dagre.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>

<script>
    // Initialize CodeMirror
    var editor = CodeMirror.fromTextArea(document.getElementById("blockCode"), {
        mode: "python",
        lineNumbers: true,
        indentUnit: 4,
        matchBrackets: true
    });

    var cy = cytoscape({
        container: document.getElementById('cy'),
        wheelSensitivity: 0.2,
        style: [
            {
                selector: 'node',
                style: {
                    'label': 'data(name)',
                    'background-color': '#007bff',
                    'color': '#fff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'width': 'label',
                    'height': 40,
                    'padding': 10,
                    'shape': 'round-rectangle'
                }
            },
            {
                selector: 'node[?is_start]',
                style: {
                    'background-color': '#28a745'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': '#ccc',
                    'target-arrow-color': '#ccc',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                }
            }
        ]
    });

    // Load Graph
    fetch('/api/graph')
        .then(res => res.json())
        .then(data => {
            cy.add(data.nodes);
            cy.add(data.edges);

            // Initial layout if positions are 0,0 (newly seeded)
            const hasPositions = data.nodes.some(n => n.position.x !== 0 || n.position.y !== 0);
            if (!hasPositions) {
                applyLayout();
            } else {
                cy.layout({ name: 'preset' }).run();
                cy.fit();
            }
        });

    // Handle Drag (Save position)
    cy.on('dragfree', 'node', function (evt) {
        var node = evt.target;
        var pos = node.position();
        var id = node.id();

        var formData = new FormData();
        formData.append('x', pos.x);
        formData.append('y', pos.y);

        fetch(`/api/blocks/${id}/position`, {
            method: 'POST',
            body: formData
        });
    });

    // Handle Click (Edit)
    cy.on('tap', 'node', function (evt) {
        var node = evt.target;
        var id = node.id();

        fetch(`/api/blocks/${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('blockId').value = data.id;
                document.getElementById('blockName').value = data.name;
                editor.setValue(data.script_code);
                document.getElementById('deleteBtn').style.display = 'block';

                // Clear previous run output
                document.getElementById('runOutput').style.display = 'none';
                document.getElementById('runOutput').textContent = '';

                // Clear error highlighting
                editor.eachLine(line => {
                    editor.removeLineClass(line, "background", "cm-error-line");
                });
            });
    });

    // Hide delete button when clicking background
    cy.on('tap', function (evt) {
        if (evt.target === cy) {
            document.getElementById('blockId').value = '';
            document.getElementById('blockName').value = '';
            editor.setValue('');
            document.getElementById('deleteBtn').style.display = 'none';
        }
    });

    function saveBlock() {
        var id = document.getElementById('blockId').value;
        if (!id) return;

        var code = editor.getValue();
        var name = document.getElementById('blockName').value;

        var formData = new FormData();
        formData.append('script_code', code);
        formData.append('name', name);

        fetch(`/api/blocks/${id}/save`, {
            method: 'POST',
            body: formData
        }).then(res => {
            // Update node label in graph
            cy.getElementById(id).data('name', name);
            alert('Saved!');
        });
    }

    function addBlock() {
        var formData = new FormData();
        // Place in center of view
        var pan = cy.pan();
        var zoom = cy.zoom();
        var x = (cy.width() / 2 - pan.x) / zoom;
        var y = (cy.height() / 2 - pan.y) / zoom;

        formData.append('x', Math.round(x));
        formData.append('y', Math.round(y));

        fetch('/api/blocks/create', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                cy.add({
                    data: { id: String(data.id), name: data.name },
                    position: { x: data.ui_x, y: data.ui_y }
                });
            });
    }

    function deleteBlock() {
        var id = document.getElementById('blockId').value;
        if (!id) return;

        if (!confirm('Are you sure you want to delete this block?')) return;

        fetch(`/api/blocks/${id}/delete`, { method: 'POST' })
            .then(res => {
                cy.remove(cy.getElementById(id));
                document.getElementById('blockId').value = '';
                document.getElementById('blockName').value = '';
                editor.setValue('');
                document.getElementById('deleteBtn').style.display = 'none';
            });
    }

    function runCode() {
        var code = editor.getValue();
        var formData = new FormData();
        formData.append('script_code', code);

        // Clear previous error highlighting
        editor.eachLine(line => {
            editor.removeLineClass(line, "background", "cm-error-line");
        });

        var outputEl = document.getElementById('runOutput');
        outputEl.style.display = 'block';
        outputEl.textContent = 'Running...';
        outputEl.className = 'mt-2 p-2 border bg-light';

        fetch('/api/validate_code', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    outputEl.textContent = "Execution Successful:\n" + data.output;
                    outputEl.className = 'mt-2 p-2 border bg-success text-white';
                } else {
                    outputEl.textContent = "Error on line " + data.line + ":\n" + data.message;
                    outputEl.className = 'mt-2 p-2 border bg-danger text-white';

                    if (data.line > 0) {
                        editor.addLineClass(data.line - 1, "background", "cm-error-line");
                    }
                }
            });
    }

    function formatCode() {
        var code = editor.getValue();
        var formData = new FormData();
        formData.append('script_code', code);

        fetch('/api/format_code', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok') {
                    editor.setValue(data.formatted_code);
                } else {
                    alert("Formatting failed: " + data.message);
                }
            });
    }

    function toggleFullscreen() {
        var cm = editor.getWrapperElement();
        var isFullscreen = cm.classList.contains("CodeMirror-fullscreen");

        if (isFullscreen) {
            cm.classList.remove("CodeMirror-fullscreen");
            editor.refresh();
        } else {
            cm.classList.add("CodeMirror-fullscreen");
            editor.refresh();
            editor.focus();
        }
    }

    // Bind F11 to fullscreen
    editor.setOption("extraKeys", {
        "F11": function (cm) {
            toggleFullscreen();
        },
        "Esc": function (cm) {
            if (cm.getWrapperElement().classList.contains("CodeMirror-fullscreen")) {
                toggleFullscreen();
            }
        }
    });

    // Zoom Controls
    function zoomIn() {
        cy.zoom(cy.zoom() * 1.2);
    }

    function zoomOut() {
        cy.zoom(cy.zoom() / 1.2);
    }

    function fitGraph() {
        cy.fit();
    }

    // Auto Layout (Sugiyama / Layered)
    function applyLayout() {
        cy.layout({
            name: 'dagre',
            rankDir: 'TB', // Top to Bottom
            ranker: 'network-simplex', // Optimal for Sugiyama
            spacingFactor: 1.2,
            nodeSep: 120, // Horizontal spacing
            rankSep: 150, // Vertical spacing
            animate: true,
            animationDuration: 500,
            fit: true,
            padding: 30
        }).run();

        // Save new positions after layout finishes
        setTimeout(() => {
            cy.nodes().forEach(node => {
                var pos = node.position();
                var id = node.id();
                var formData = new FormData();
                formData.append('x', pos.x);
                formData.append('y', pos.y);
                fetch(`/api/blocks/${id}/position`, { method: 'POST', body: formData });
            });
        }, 600);
    }
</script>
{% endblock %}